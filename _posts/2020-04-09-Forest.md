# Forest HTB Writeup 
![HTB Overivew](/assets/forest/forest-overview2.png)
# Overview
Forest is an *Easy* rated Windows box and features Active Directory based techniques. This box was released on October 2019 and created by egre55 & mrb3n. This is one my favorite boxes from HTB since the enumeration techniques are both practical and serve good practice for the OSCP. This post also has a video walkthrough (*see below*) which explains some of the attacks and challenges I faced.



## Key Takeaways
1. Anonymous access to enumerate domain information
2. AS-REP Roasting technique 
3. Use *BloodHound* and *aclpwn* for domain dominance 



## Walkthrough 

#### Enumeration:
We start by running a basic port scan for all TCP ports. Immediately, we notice the box resembles a Domain Controller due to DNS, Kerberos, and LDAP being enabled. However, there are no additional interesting services enabled such HTTP, FTP, and Telnet. This implies we most likely need to leverage Active Directory techniques on the box. 

![Nmap Scan](/assets/forest/nmap.png)

To start, we can enumerate LDAP and SMB through anonymous authentication. *Network access: Do not allow anonymous enumeration of SAM accounts*. By default, this configuration is disabled by default. When enabled, any user with network access can dump valid domain accounts. 

![FQDN](/assets/forest/fqdn.png)

![Anonymous Access](/assets/forest/anonymous.png)

We have a wide range of tools that can enumerate accounts on the target. We are interested in creating a user list is to potentially perform password brute forcing or to query LDAP if a credential was left behind in a data field. I used *rpcclient* and *ridenum* to create a user list. 

![RPC Client](/assets/forest/rpcclientII.png)

![Ridenum](/assets/forest/ridenum.png)

This enumeration provides us with two facts. First, we have valid domain accounts and most notably a service account we can target for more information. Second, the box seems have Exchange service enabled due to the HealthMailboxXXXXXXX accounts found. We should keep track of this information as it will probably be needed for privilege escalation. 

#### Foothold:

However, we are now presented with our the first challenge. Brute forcing passwords is not viable and plaintext/hashed credentials cannot be found through LDAP. To gain a foothold, we perform a Keberos attack called AS-REP Roasting. An *impacket* script as well as Metasploit module can target the Keberos service and identify any accounts that are AS-REP Roastable. 


![GetNPUsers Description](/assets/forest/getnpuser-desc.png)

While the box was still active, I learned about this technique through the GetNPUsers.py *impacket* script description. A great blog post from [harmj0y](https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/) covers the technique in great detail. Any domain account that has the *"Do not require Kerberos preauthentication"* flag enabled can be AS-REP Roasted.

![Pre-auth](/assets/forest/preauth.png)

This configuration effectively removes the Kerberoasting constraint of requiring access to a domain account. Any user on the network can request TGS tickets for those accounts. Thus, we can use our previously enumerated user account to check if this setting is present and request a ticket. 

![ASRep Roasting](/assets/forest/asrep.png)





#### Obstacles Faced:
AS-REP Roasting was a brand new technique for me. I had to get some hints to learn about this method to execute it while the machine was active.Additionally, I researched multiple tools that can perform this attack to keep it in mind for future CTF's and challenges. 

**Lesson Learn:** Always remember to enumerate the services in front of you fully. It is easy to fall into a rabbit hole if we do not widen our search.